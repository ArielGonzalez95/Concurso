<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>RIP Twentie üíÄü™¶</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      background-color: #000;
      color: #ff7518;
      font-family: 'Creepster', cursive, Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }

    h1 {
      color: #ff0000;
      font-size: 3em;
      text-shadow: 2px 2px 5px #333;
      margin-bottom: 20px;
    }

    video, img {
      width: 250px;
      border-radius: 12px;
      margin: 10px 0;
    }

    button {
      background: #ff0000;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      font-family: 'Creepster', cursive;
      text-shadow: 1px 1px 2px #000;
      margin-top: 10px;
    }

    button:disabled {
      background: #555;
      cursor: not-allowed;
    }

    input[type="text"] {
      padding: 8px;
      border-radius: 5px;
      border: 2px solid #ff7518;
      margin-bottom: 10px;
      width: 200px;
    }

    #opciones-foto {
      margin-bottom: 15px;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Creepster&display=swap" rel="stylesheet">
</head>
<body>
  <h1>RIP Twentie üíÄü™¶</h1>

 <form id="form-inscripcion">
  <input type="text" id="nombre" placeholder="Tu nombre" required>

  <div id="opciones-foto">
    <button type="button" id="usar-camara">üì∏ Usar c√°mara</button>
    <input type="file" id="subir-foto" accept="image/*" capture="environment">
  </div>

  <video id="camara" autoplay playsinline style="display:none;"></video>
  <canvas id="fotoCanvas" style="display:none;"></canvas>
  <img id="preview" src="" alt="Previsualizaci√≥n" style="display:none;">

  <button type="button" id="btn-capturar" style="display:none;">Tomar foto</button>
  <button type="submit">Enviar Inscripci√≥n</button>
</form>

<!-- Mensaje din√°mico -->
<div id="mensaje" style="margin-top:15px; font-size:1.1em; color:#28a745; font-weight:bold;"></div>

  <script type="module" src="supabaseClient.js"></script>
  <script type="module">
   import { supabase } from './supabaseClient.js'

const video = document.getElementById('camara')
const canvas = document.getElementById('fotoCanvas')
const btnCamara = document.getElementById('usar-camara')
const btnCapturar = document.getElementById('btn-capturar')
const inputArchivo = document.getElementById('subir-foto')
const preview = document.getElementById('preview')
const form = document.getElementById('form-inscripcion')
const mensaje = document.getElementById('mensaje')
let fotoBlob = null

// Verificar si ya particip√≥
if (localStorage.getItem('participo')) {
  form.style.display = 'none'
  mensaje.style.display = 'block'
  mensaje.innerHTML = '‚úÖ Ya participaste. Gracias por participar!'
}

// üëâ Opci√≥n 1: usar la c√°mara directamente
btnCamara.addEventListener('click', async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ video: true })
  video.srcObject = stream
  video.style.display = 'block'
  btnCapturar.style.display = 'inline-block'
})

btnCapturar.addEventListener('click', () => {
  const ctx = canvas.getContext('2d')
  canvas.width = video.videoWidth
  canvas.height = video.videoHeight
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height)
  canvas.toBlob(blob => {
    fotoBlob = blob
    preview.src = URL.createObjectURL(blob)
    preview.style.display = 'block'
  }, 'image/jpeg')
})

// üëâ Opci√≥n 2: subir archivo desde galer√≠a o PC
inputArchivo.addEventListener('change', (e) => {
  const file = e.target.files[0]
  if (file) {
    fotoBlob = file
    preview.src = URL.createObjectURL(file)
    preview.style.display = 'block'
  }
})

// üëâ Enviar formulario
form.addEventListener('submit', async (e) => {
  e.preventDefault()

  if (localStorage.getItem('participo')) {
    mensaje.style.display = 'block'
    mensaje.innerHTML = '‚ö†Ô∏è Ya participaste previamente.'
    return
  }

  const nombre = document.getElementById('nombre').value.trim()
  if (!fotoBlob) {
    mensaje.style.display = 'block'
    mensaje.style.color = '#ff0000'
    mensaje.innerHTML = '‚ö†Ô∏è Primero sac√° o sub√≠ una foto.'
    return
  }

  const fileName = `${Date.now()}_${nombre}.jpg`
  const { data, error } = await supabase.storage
    .from('disfraces')
    .upload(fileName, fotoBlob, { contentType: 'image/jpeg' })
  if (error) {
    mensaje.style.display = 'block'
    mensaje.style.color = '#ff0000'
    mensaje.innerHTML = '‚ö†Ô∏è Error subiendo imagen: ' + error.message
    return
  }

  const { data: publicUrl } = supabase.storage
    .from('disfraces')
    .getPublicUrl(fileName)

  const { error: insertError } = await supabase
    .from('participantes')
    .insert([{ nombre, foto_url: publicUrl.publicUrl, votos: 0 }])

  if (insertError) {
    mensaje.style.display = 'block'
    mensaje.style.color = '#ff0000'
    mensaje.innerHTML = '‚ö†Ô∏è Error guardando inscripci√≥n: ' + insertError.message
    return
  }

  // ‚úÖ Guardar localStorage que ya particip√≥
  localStorage.setItem('participo', 'true')
  form.style.display = 'none'
  mensaje.style.display = 'block'
  mensaje.style.color = '#28a745'
  mensaje.innerHTML = '‚úÖ Inscripci√≥n enviada correctamente. Gracias por participar!'
})

  </script>
</body>
</html>
